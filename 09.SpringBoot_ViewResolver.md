# 09. SpringBoot View Resolver

## Q05. View Resolver와 종류, 사용법 그리고 Controller, RestController의 관계를 상세히 설명해줘

### 1. View Resolver의 개념과 역할

#### 1.1 View Resolver란?
- **View Resolver**는 Controller가 반환한 View 이름을 실제 View 객체로 변환하는 컴포넌트입니다.
- DispatcherServlet이 Controller의 반환값을 받은 후, View Resolver를 통해 적절한 View를 찾아 렌더링합니다.
- 다양한 템플릿 엔진(JSP, Thymeleaf, FreeMarker 등)을 지원하기 위한 추상화 계층입니다.

#### 1.2 View Resolver의 위치
```
요청 → DispatcherServlet → HandlerMapping → Handler Adapter → Controller → View Resolver → View → 응답
```

#### 1.3 View Resolver의 주요 역할
1. **View 이름 해석**: Controller가 반환한 문자열을 View 객체로 변환
2. **템플릿 엔진 지원**: 다양한 템플릿 엔진에 대한 추상화
3. **View 우선순위 관리**: 여러 View Resolver 간의 우선순위 설정
4. **캐싱 지원**: View 객체의 캐싱을 통한 성능 최적화
5. **국제화 지원**: Locale에 따른 View 선택

### 2. View Resolver의 구조와 인터페이스

#### 2.1 ViewResolver 인터페이스
```java
public interface ViewResolver {
    
    /**
     * View 이름을 View 객체로 변환
     * @param viewName Controller가 반환한 View 이름
     * @param locale 현재 Locale 정보
     * @return View 객체, 찾지 못하면 null
     */
    View resolveViewName(String viewName, Locale locale) throws Exception;
}
```

#### 2.2 View 인터페이스
```java
public interface View {
    
    /**
     * View의 Content-Type 반환
     */
    String getContentType();
    
    /**
     * View 렌더링 수행
     */
    void render(Map<String, ?> model, 
                HttpServletRequest request, 
                HttpServletResponse response) throws Exception;
}
```

### 3. 주요 View Resolver 종류

#### 3.1 InternalResourceViewResolver (JSP)
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Bean
    public ViewResolver jspViewResolver() {
        InternalResourceViewResolver resolver = new InternalResourceViewResolver();
        resolver.setPrefix("/WEB-INF/views/");  // View 파일 경로 접두사
        resolver.setSuffix(".jsp");             // View 파일 확장자
        resolver.setViewClass(JstlView.class);  // View 클래스
        resolver.setOrder(1);                   // 우선순위
        return resolver;
    }
}
```

**사용 예제:**
```java
@Controller
@RequestMapping("/users")
public class UserController {
    
    @GetMapping("/list")
    public String listUsers(Model model) {
        List<User> users = userService.findAll();
        model.addAttribute("users", users);
        return "users/list"; // → /WEB-INF/views/users/list.jsp
    }
}
```

#### 3.2 ThymeleafViewResolver (Thymeleaf)
```java
@Configuration
public class ThymeleafConfig {
    
    @Bean
    public ViewResolver thymeleafViewResolver() {
        ThymeleafViewResolver resolver = new ThymeleafViewResolver();
        resolver.setTemplateEngine(templateEngine());
        resolver.setCharacterEncoding("UTF-8");
        resolver.setOrder(1);
        return resolver;
    }
    
    @Bean
    public SpringTemplateEngine templateEngine() {
        SpringTemplateEngine engine = new SpringTemplateEngine();
        engine.setTemplateResolver(templateResolver());
        return engine;
    }
    
    @Bean
    public ITemplateResolver templateResolver() {
        SpringResourceTemplateResolver resolver = new SpringResourceTemplateResolver();
        resolver.setPrefix("classpath:/templates/");
        resolver.setSuffix(".html");
        resolver.setTemplateMode(TemplateMode.HTML);
        return resolver;
    }
}
```

**사용 예제:**
```java
@Controller
@RequestMapping("/products")
public class ProductController {
    
    @GetMapping("/detail/{id}")
    public String productDetail(@PathVariable Long id, Model model) {
        Product product = productService.findById(id);
        model.addAttribute("product", product);
        return "products/detail"; // → classpath:/templates/products/detail.html
    }
}
```

#### 3.3 FreeMarkerViewResolver (FreeMarker)
```java
@Configuration
public class FreeMarkerConfig {
    
    @Bean
    public ViewResolver freeMarkerViewResolver() {
        FreeMarkerViewResolver resolver = new FreeMarkerViewResolver();
        resolver.setCache(true);
        resolver.setPrefix("");
        resolver.setSuffix(".ftl");
        resolver.setContentType("text/html; charset=UTF-8");
        resolver.setOrder(1);
        return resolver;
    }
    
    @Bean
    public FreeMarkerConfigurer freeMarkerConfigurer() {
        FreeMarkerConfigurer configurer = new FreeMarkerConfigurer();
        configurer.setTemplateLoaderPath("classpath:/templates/");
        return configurer;
    }
}
```

#### 3.4 ContentNegotiatingViewResolver
```java
@Configuration
public class ContentNegotiationConfig {
    
    @Bean
    public ViewResolver contentNegotiatingViewResolver() {
        ContentNegotiatingViewResolver resolver = new ContentNegotiatingViewResolver();
        
        // 지원하는 View Resolver들 설정
        List<ViewResolver> viewResolvers = Arrays.asList(
            jspViewResolver(),
            jsonViewResolver(),
            xmlViewResolver()
        );
        resolver.setViewResolvers(viewResolvers);
        
        // 기본 View 설정
        resolver.setDefaultViews(Arrays.asList(
            new MappingJackson2JsonView(),
            new MappingJackson2XmlView()
        ));
        
        return resolver;
    }
}
```

### 4. Controller와 RestController의 관계

#### 4.1 Controller vs RestController

**@Controller (전통적인 MVC)**
```java
@Controller
@RequestMapping("/users")
public class UserController {
    
    @GetMapping("/list")
    public String listUsers(Model model) {
        List<User> users = userService.findAll();
        model.addAttribute("users", users);
        return "users/list"; // View 이름 반환
    }
    
    @PostMapping("/create")
    public String createUser(@ModelAttribute User user, 
                           RedirectAttributes redirectAttributes) {
        userService.save(user);
        redirectAttributes.addFlashAttribute("message", "사용자가 생성되었습니다.");
        return "redirect:/users/list"; // 리다이렉트
    }
}
```

**@RestController (REST API)**
```java
@RestController
@RequestMapping("/api/users")
public class UserRestController {
    
    @GetMapping("/list")
    public ResponseEntity<List<User>> listUsers() {
        List<User> users = userService.findAll();
        return ResponseEntity.ok(users); // JSON 응답
    }
    
    @PostMapping("/create")
    public ResponseEntity<User> createUser(@RequestBody User user) {
        User savedUser = userService.save(user);
        return ResponseEntity.status(HttpStatus.CREATED).body(savedUser);
    }
}
```

#### 4.2 View Resolver와의 관계

**@Controller의 경우:**
```
Controller → View 이름 반환 → View Resolver → View 렌더링 → HTML 응답
```

**@RestController의 경우:**
```
Controller → 객체 반환 → HttpMessageConverter → JSON/XML 응답
```

### 5. View Resolver의 상세 동작 과정

#### 5.1 View Resolver 체인 처리
```java
// DispatcherServlet에서 View 처리
protected void render(ModelAndView mv, 
                     HttpServletRequest request, 
                     HttpServletResponse response) throws Exception {
    
    // 1. View 이름 추출
    String viewName = mv.getViewName();
    
    // 2. View Resolver를 통해 View 객체 찾기
    View view = resolveViewName(viewName, mv.getModelInternal(), locale, request);
    
    if (view == null) {
        throw new ServletException("Could not resolve view with name '" + viewName + "'");
    }
    
    // 3. View 렌더링
    view.render(mv.getModelInternal(), request, response);
}

// View Resolver 체인에서 View 찾기
protected View resolveViewName(String viewName, 
                              Map<String, Object> model, 
                              Locale locale, 
                              HttpServletRequest request) throws Exception {
    
    // 등록된 모든 View Resolver를 순회
    for (ViewResolver viewResolver : this.viewResolvers) {
        View view = viewResolver.resolveViewName(viewName, locale);
        if (view != null) {
            return view;
        }
    }
    
    return null;
}
```

#### 5.2 실제 View Resolver 동작 예제
```java
@Component
public class CustomViewResolver implements ViewResolver {
    
    @Override
    public View resolveViewName(String viewName, Locale locale) throws Exception {
        
        // 특정 접두사로 시작하는 View 처리
        if (viewName.startsWith("excel:")) {
            return new ExcelView();
        }
        
        // PDF View 처리
        if (viewName.startsWith("pdf:")) {
            return new PdfView();
        }
        
        // 기본 JSP View 처리
        if (viewName.endsWith(".jsp")) {
            return new InternalResourceView("/WEB-INF/views/" + viewName);
        }
        
        return null; // 다른 View Resolver에게 위임
    }
}
```

### 6. 다양한 View Resolver 사용 예제

#### 6.1 JSON View Resolver
```java
@Configuration
public class JsonViewConfig {
    
    @Bean
    public ViewResolver jsonViewResolver() {
        MappingJackson2JsonView view = new MappingJackson2JsonView();
        view.setPrettyPrint(true);
        
        return new ViewResolver() {
            @Override
            public View resolveViewName(String viewName, Locale locale) throws Exception {
                if (viewName.startsWith("json:")) {
                    return view;
                }
                return null;
            }
        };
    }
}

// 사용 예제
@Controller
public class ApiController {
    
    @GetMapping("/data")
    public String getData(Model model) {
        model.addAttribute("data", "Hello World");
        return "json:data"; // JSON 응답
    }
}
```

#### 6.2 Excel View Resolver
```java
@Component
public class ExcelViewResolver implements ViewResolver {
    
    @Override
    public View resolveViewName(String viewName, Locale locale) throws Exception {
        if (viewName.startsWith("excel:")) {
            return new ExcelView();
        }
        return null;
    }
}

public class ExcelView implements View {
    
    @Override
    public String getContentType() {
        return "application/vnd.ms-excel";
    }
    
    @Override
    public void render(Map<String, ?> model, 
                      HttpServletRequest request, 
                      HttpServletResponse response) throws Exception {
        
        response.setHeader("Content-Disposition", "attachment; filename=data.xlsx");
        
        // Excel 파일 생성 로직
        Workbook workbook = new XSSFWorkbook();
        Sheet sheet = workbook.createSheet("Data");
        
        // 데이터를 Excel에 작성
        int rowNum = 0;
        for (Map.Entry<String, ?> entry : model.entrySet()) {
            Row row = sheet.createRow(rowNum++);
            row.createCell(0).setCellValue(entry.getKey());
            row.createCell(1).setCellValue(entry.getValue().toString());
        }
        
        workbook.write(response.getOutputStream());
        workbook.close();
    }
}
```

#### 6.3 PDF View Resolver
```java
@Component
public class PdfViewResolver implements ViewResolver {
    
    @Override
    public View resolveViewName(String viewName, Locale locale) throws Exception {
        if (viewName.startsWith("pdf:")) {
            return new PdfView();
        }
        return null;
    }
}

public class PdfView implements View {
    
    @Override
    public String getContentType() {
        return "application/pdf";
    }
    
    @Override
    public void render(Map<String, ?> model, 
                      HttpServletRequest request, 
                      HttpServletResponse response) throws Exception {
        
        response.setHeader("Content-Disposition", "attachment; filename=report.pdf");
        
        // PDF 생성 로직
        Document document = new Document();
        PdfWriter.getInstance(document, response.getOutputStream());
        document.open();
        
        // PDF 내용 작성
        for (Map.Entry<String, ?> entry : model.entrySet()) {
            document.add(new Paragraph(entry.getKey() + ": " + entry.getValue()));
        }
        
        document.close();
    }
}
```

### 7. View Resolver 설정과 커스터마이징

#### 7.1 다중 View Resolver 설정
```java
@Configuration
public class MultiViewResolverConfig implements WebMvcConfigurer {
    
    @Override
    public void configureViewResolvers(ViewResolverRegistry registry) {
        
        // 1. JSP View Resolver (우선순위 1)
        registry.jsp("/WEB-INF/views/", ".jsp")
                .order(1);
        
        // 2. Thymeleaf View Resolver (우선순위 2)
        registry.thymeleaf()
                .prefix("classpath:/templates/")
                .suffix(".html")
                .order(2);
        
        // 3. JSON View Resolver (우선순위 3)
        registry.viewResolver(jsonViewResolver())
                .order(3);
    }
    
    @Bean
    public ViewResolver jsonViewResolver() {
        return new ViewResolver() {
            @Override
            public View resolveViewName(String viewName, Locale locale) throws Exception {
                if (viewName.startsWith("json:")) {
                    return new MappingJackson2JsonView();
                }
                return null;
            }
        };
    }
}
```

#### 7.2 조건부 View Resolver
```java
@Component
public class ConditionalViewResolver implements ViewResolver {
    
    @Value("${app.view.type:jsp}")
    private String viewType;
    
    @Override
    public View resolveViewName(String viewName, Locale locale) throws Exception {
        
        switch (viewType) {
            case "thymeleaf":
                return resolveThymeleafView(viewName);
            case "freemarker":
                return resolveFreeMarkerView(viewName);
            default:
                return resolveJspView(viewName);
        }
    }
    
    private View resolveThymeleafView(String viewName) {
        // Thymeleaf View 해석 로직
        return new ThymeleafView(viewName);
    }
    
    private View resolveFreeMarkerView(String viewName) {
        // FreeMarker View 해석 로직
        return new FreeMarkerView(viewName);
    }
    
    private View resolveJspView(String viewName) {
        // JSP View 해석 로직
        return new InternalResourceView("/WEB-INF/views/" + viewName + ".jsp");
    }
}
```

### 8. 성능 최적화

#### 8.1 View 캐싱
```java
@Component
public class CachedViewResolver implements ViewResolver {
    
    private final Map<String, View> viewCache = new ConcurrentHashMap<>();
    
    @Override
    public View resolveViewName(String viewName, Locale locale) throws Exception {
        
        String cacheKey = viewName + "_" + locale.toString();
        
        return viewCache.computeIfAbsent(cacheKey, key -> {
            // 실제 View 해석 로직
            return createView(viewName, locale);
        });
    }
    
    private View createView(String viewName, Locale locale) {
        // View 생성 로직
        return new InternalResourceView("/WEB-INF/views/" + viewName + ".jsp");
    }
}
```

#### 8.2 비동기 View 렌더링
```java
@Component
public class AsyncViewResolver implements ViewResolver {
    
    @Async
    public CompletableFuture<View> resolveViewNameAsync(String viewName, Locale locale) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                return resolveViewName(viewName, locale);
            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        });
    }
}
```

### 9. 디버깅과 모니터링

#### 9.1 View Resolver 로깅
```properties
# application.properties
logging.level.org.springframework.web.servlet.view=DEBUG
logging.level.org.springframework.web.servlet.view.InternalResourceViewResolver=DEBUG
```

#### 9.2 View Resolver 성능 모니터링
```java
@Component
public class PerformanceViewResolver implements ViewResolver {
    
    @Override
    public View resolveViewName(String viewName, Locale locale) throws Exception {
        
        long startTime = System.currentTimeMillis();
        
        try {
            return delegate.resolveViewName(viewName, locale);
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            log.info("View Resolver 처리 시간: {}ms, View: {}", duration, viewName);
        }
    }
}
```

### 10. 주의사항과 모범 사례

#### 10.1 주의사항
1. **View Resolver 순서**: 우선순위가 높은 View Resolver부터 처리
2. **캐싱 전략**: 개발 환경에서는 캐싱 비활성화 권장
3. **예외 처리**: View를 찾지 못했을 때의 예외 처리
4. **성능 고려**: 복잡한 View 해석 로직은 성능에 영향

#### 10.2 모범 사례
1. **명확한 View 이름**: 일관된 명명 규칙 사용
2. **적절한 View Resolver 선택**: 요구사항에 맞는 View Resolver 사용
3. **캐싱 활용**: 프로덕션 환경에서 View 캐싱 활성화
4. **모니터링**: View Resolver 성능 모니터링 추가

이러한 방식으로 View Resolver는 Spring MVC에서 Controller의 반환값을 적절한 View로 변환하여 클라이언트에게 응답을 제공하는 중요한 역할을 수행합니다. 